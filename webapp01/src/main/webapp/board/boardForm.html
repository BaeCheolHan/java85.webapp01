<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시물 입력폼</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<style>
.container {
  width: 600px;
}


</style>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>
<body>
<div class="container">     
<div style='background-color:navy;font-size:150%;color:white;position:relative;'>
  자바85기^^

  <div style='position:absolute;right:0px;top:0px;font-size:15px;'>
    <a href='/webapp01/auth/form.do'
       class="btn btn-success btn-xs">로그인</a></div> 

</div>

<h1>게시물 입력폼</h1>
<form class="form-horizontal">
<div class="form-group my-view">
  <label for="no" class="col-sm-2 control-label">번호</label>
  <div class="col-sm-10">
    <input type="text" class="form-control" id="no" readonly>
  </div>
</div>
<div class="form-group">
  <label for="title" class="col-sm-2 control-label">제목</label>
  <div class="col-sm-10">
    <input type="text" class="form-control" id="title" placeholder="제목입니다.">
  </div>
</div>
<div class="form-group">
  <label for="contents" class="col-sm-2 control-label">내용</label>
  <div class="col-sm-10">
    <textarea id="contents" class="form-control" 
              cols="50" rows="10" placeholder="내용입니다."></textarea>
  </div>
</div>
<div class="form-group">
  <label for="password" class="col-sm-2 control-label">암호</label>
  <div class="col-sm-10">
    <input type="password" id="password" class="form-control" 
           placeholder="암호입력">
  </div>
</div>
<div class="form-group my-view">
  <label class="col-sm-2 control-label">등록일</label>
  <div class="col-sm-10">
    <p id="createdDate" class="form-control-static"></p>
  </div>
</div>
<div class="form-group my-view">
  <label class="col-sm-2 control-label">조회수</label>
  <div class="col-sm-10">
    <p id="viewCount" class="form-control-static"></p>
  </div>
</div>
<div class="form-group">
  <div class="col-sm-offset-2 col-sm-10">
    <button id="addBtn" type="button" class="btn btn-default my-new">등록</button>
    <button id="updateBtn" type="button" class="btn btn-default my-view">변경</button>
    <button id="deleteBtn" type="button" class="btn btn-default my-view">삭제</button>
    <button id="cancelBtn" type="button" class="btn btn-default"
            onclick="location.href='boardApp.html'">취소</button>
  </div>
</div>
</form>

<p style='background-color:yellow; text-align:center;'>
  이 예제는 자바85기에서 사용한 것입니다.2</p>
  
</div><!-- div.container -->

<script>

// URL에 no 파라미터 값이 넘어오면 조회 모드로 동작해야 한다.
if (location.search.startsWith("?")) { // 예) ?no=xxx
	  var no = location.search.split("=")[1];
	  ajaxLoadBoard(no)
	  var tags = document.querySelectorAll(".my-new")
    for (var i = 0; i < tags.length; i++) {
      tags[i].style.display = "none"
    }
} else {
	  var tags = document.querySelectorAll(".my-view")
	  for (var i = 0; i < tags.length; i++) {
		  tags[i].style.display = "none"
	  }
}

document.querySelector("#addBtn").addEventListener("click", function(event) {
	var board = {
	  title: document.querySelector("#title").value,
	  contents: document.querySelector("#contents").value,
	  password: document.querySelector("#password").value
	}
	ajaxAddBoard(board)
});

document.querySelector("#updateBtn").addEventListener("click", function(event) {
  var board = {
    title: document.querySelector("#title").value,
    contents: document.querySelector("#contents").value,
    password: document.querySelector("#password").value,
    no: document.querySelector("#no").value
  }
  ajaxUpdateBoard(board)
});

document.querySelector("#deleteBtn").addEventListener("click", function(event) {
  ajaxDeleteBoard(document.querySelector("#no").value)
});

function ajaxAddBoard(board) {
	  var xhr = new XMLHttpRequest();
	  xhr.onreadystatechange = function() {
	    if (xhr.readyState != 4)
	      return;
	    
	    if (xhr.status != 200) {
	      alert("서버에 잘못 요청했습니다.")
	      return;
	    }
	    
	    var result = JSON.parse(xhr.responseText)
	    /* result 예)
	       {
	    	   state : "success" or "fail",
	    	   data : 결과 데이터 
	       }
	     */
	    if (result.state != "success") {
	    	 console.log(result.data)
	    	 alert("등록 실패입니다.")
	    	 return
	    }
	    
	    window.location.href = "boardApp.html"
	  }
	  xhr.open("POST", "add.json", true)
	  
	  // POST 요청은 헤더를 추가해야 한다.
	  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8"); 
	  
	  // POST 요청은 서버에 데이터를 보낼 때 send()의 파라미터로 보낸다.
	  var params = "title=" + encodeURIComponent(board.title) + 
	               "&contents=" + encodeURIComponent(board.contents) + 
	               "&password=" + encodeURIComponent(board.password)
	  
	  // 웹브라우저인 경우 자동으로 데이터에 대해 URL인코딩을 수행한다.
	  // 그런데 자바스크립트 AJAX에서는 개발자가 직접 URL인코딩을 수행해야 한다.
	  xhr.send(params) 
}

function ajaxLoadBoard(no) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState != 4)
        return;
      
      if (xhr.status != 200) {
        alert("서버에 잘못 요청했습니다.")
        return;
      }
      
      var result = JSON.parse(xhr.responseText)
      /* result 예)
         {
           state : "success" or "fail",
           data : 결과 데이터 
         }
       */
      if (result.state != "success") {
         console.log(result.data)
         alert("조회 실패입니다.")
         return
      }
      
      // 서버에서 받은 데이터로 폼을 채운다.
      document.querySelector("#no").value = result.data.no;
      document.querySelector("#title").value = result.data.title;
      document.querySelector("#contents").value = result.data.contents;
      document.querySelector("#createdDate").textContent = result.data.createdDate2;
      document.querySelector("#viewCount").textContent = result.data.viewCount;
    }
    
    //GET 요청은 반드시 파라미터 값을 URL에 포함시켜 보내야 한다.
    xhr.open("GET", "detail.json?no=" + no, true)
    xhr.send() 
}

function ajaxUpdateBoard(board) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState != 4)
        return;
      
      if (xhr.status != 200) {
        alert("서버에 잘못 요청했습니다.")
        return;
      }
      
      var result = JSON.parse(xhr.responseText)
      if (result.state != "success") {
         console.log(result.data)
         alert("변경 실패입니다.")
         return
      }
      
      window.location.href = "boardApp.html"
    }
    xhr.open("POST", "update.json", true)
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8"); 
    var params = "title=" + encodeURIComponent(board.title) + 
                 "&contents=" + encodeURIComponent(board.contents) + 
                 "&password=" + encodeURIComponent(board.password) +
                 "&no=" + board.no
    xhr.send(params) 
}

function ajaxDeleteBoard(no) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState != 4)
        return;
      
      if (xhr.status != 200) {
        alert("서버에 잘못 요청했습니다.")
        return;
      }
      
      var result = JSON.parse(xhr.responseText)
      if (result.state != "success") {
         console.log(result.data)
         alert("삭제 실패입니다.")
         return
      }

      location.href = "boardApp.html"
    }
    
    xhr.open("GET", "delete.json?no=" + no, true)
    xhr.send() 
}

</script>


</body>
</html>








