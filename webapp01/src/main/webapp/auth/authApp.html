<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<style>
.container {
  width: 600px;
}
</style>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>
<body>
<div class="container">     
<div style='background-color:navy;font-size:150%;color:white;position:relative;'>
  자바85기^^
</div>

<h1>로그인</h1>
<form class="form-horizontal">
<div class="form-group">
  <label for="email" class="col-sm-2 control-label">이메일</label>
  <div class="col-sm-10">
    <input type="text" class="form-control" id="email" placeholder="예) hong@bit.com">
  </div>
</div>
<div class="form-group">
  <label for="password" class="col-sm-2 control-label">암호</label>
  <div class="col-sm-10">
    <input type="password" id="password" class="form-control" 
           placeholder="암호입력">
  </div>
</div>
<div class="form-group">
  <div class="col-sm-offset-2 col-sm-10">
    <div class="checkbox">
      <label>
        <input id="saveEmail" type="checkbox"> 아이디 저장
      </label>
    </div>
  </div>
</div>
<div class="form-group">
  <div class="col-sm-offset-2 col-sm-10">
    <button id="loginBtn" type="button" class="btn btn-default">로그인</button>
  </div>
</div>
</form>
      
<p style='background-color:yellow; text-align:center;'>
  이 예제는 자바85기에서 사용한 것입니다.2</p>
</div>

<script>

init() // 화면을 준비시킨다.

ajaxLogout() // 로그아웃을 무조건 실행

document.querySelector("#loginBtn").addEventListener("click", function(event) {
	var user = {
    email: document.querySelector("#email").value,
    password: document.querySelector("#password").value,
    saveEmail: document.querySelector("#saveEmail").checked 
  }
	
  ajaxLogin(user)
});

function ajaxLogin(user) {
	  var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(result) {
      if (xhr.readyState != 4)
        return;
      
      if (xhr.status != 200) {
        alert("서버에 잘못 요청했습니다.")
        return;
      }
      
      var result = JSON.parse(xhr.responseText)
      if (result.state != "success") {
         console.log(result.data)
         alert("로그인 실패입니다.\n이메일 또는 암호를 확인하세요.")
         return
      }
      
      window.location.href = "../board/boardApp.html"
    }
    xhr.open("POST", "login.json", true)
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded;charset=UTF-8"); 
    
    var params = "email=" + user.email + "&password=" + user.password;
    if (user.saveEmail == true) {
    	params += "&saveEmail=on"
    }

    xhr.send(params) 
}

function ajaxLogout(user) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(result) {
      if (xhr.readyState != 4)
        return;
      
      if (xhr.status != 200) {
        console.log("서버 요청 오류입니다.")
        return;
      }
      
      var result = JSON.parse(xhr.responseText)
      if (result.state != "success")
        console.log("로그아웃 실패입니다.")
    }
    xhr.open("GET", "logout.json", true)
    xhr.send() 
}

function init() {
	var cookieMap = cookieToObject()
	
	//if (cookieMap["email"]) { // cookieMap 객체에 email 이름으로 저장된 값이 있는가?
  if ("email" in cookieMap) { // cookieMap 객체에 email 이라는 이름의 프로퍼티가 있는가?
		document.querySelector("#email").value = cookieMap["email"]
	  document.querySelector("#saveEmail").checked = true
	}
}

function cookieToObject() {
	var cookies = document.cookie.split(";")
	var obj = {}
	
	if (cookies.length == 0) 
		return obj;
	
  cookies.forEach(function(data) {
	  var cookie = data.trim().split("=")
	  obj[cookie[0]] = cookie[1].replace(/\"/gi, "")
  });
    
	return obj
}
</script>


</body>
</html>




